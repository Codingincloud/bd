{% extends 'donor/base_donor.html' %}

{% block title %}Emergency Requests | Blood Donor Information Management System{% endblock %}

{% block extra_css %}
<style>
    .emergency-card {
        background: white;
        border: 2px solid var(--color-danger-600);
        border-radius: var(--radius-xl);
        padding: var(--space-6);
        margin-bottom: var(--space-6);
        transition: var(--transition-base);
        position: relative;
    }

    .emergency-card:hover {
        box-shadow: var(--shadow-lg);
        transform: translateY(-2px);
    }

    .emergency-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--color-danger-600), var(--color-warning-600));
    }

    .emergency-card.critical {
        border-color: var(--color-danger-600);
        background: var(--color-danger-50);
    }

    .emergency-card.high {
        border-color: var(--color-warning-600);
        background: var(--color-warning-50);
    }

    .emergency-card.medium {
        border-color: var(--color-info-600);
        background: var(--color-info-50);
    }

    .emergency-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: var(--space-4);
    }

    .emergency-info h3 {
        color: var(--color-danger-600);
        margin-bottom: var(--space-1);
        font-size: var(--text-xl);
        display: flex;
        align-items: center;
        gap: var(--space-2);
    }

    .emergency-info p {
        color: var(--color-gray-600);
        font-size: var(--text-sm);
    }

    .urgency-badge {
        padding: var(--space-1) var(--space-3);
        border-radius: var(--radius-xl);
        font-size: var(--text-xs);
        font-weight: var(--font-weight-semibold);
        text-transform: uppercase;
    }

    .urgency-critical {
        background: var(--color-danger-600);
        color: white;
    }

    .urgency-high {
        background: var(--color-warning-600);
        color: white;
    }

    .urgency-medium {
        background: var(--color-info-600);
        color: white;
    }

    .emergency-details {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: var(--space-4);
        margin-bottom: var(--space-4);
    }

    .detail-item {
        display: flex;
        flex-direction: column;
        gap: var(--space-1);
    }

    .detail-label {
        font-size: var(--text-xs);
        color: var(--color-gray-500);
        text-transform: uppercase;
        font-weight: var(--font-weight-semibold);
    }

    .detail-value {
        color: var(--color-gray-800);
        font-weight: var(--font-weight-medium);
    }

    .emergency-actions {
        display: flex;
        gap: var(--space-2);
        flex-wrap: wrap;
    }

    .btn-respond {
        background: var(--color-success-600);
        color: white;
    }

    .btn-respond:hover {
        background: var(--color-success-700);
    }

    .btn-contact {
        background: var(--color-info-600);
        color: white;
    }

    .btn-contact:hover {
        background: var(--color-info-700);
    }

    .btn-schedule {
        background: var(--color-primary-600);
        color: white;
    }

    .btn-schedule:hover {
        background: var(--color-primary-700);
    }

    .no-emergencies {
        text-align: center;
        padding: var(--space-12);
        color: var(--color-gray-500);
    }

    .no-emergencies i {
        font-size: var(--text-5xl);
        color: var(--color-success-600);
        margin-bottom: var(--space-4);
        opacity: 0.5;
    }

    .no-emergencies h3 {
        font-size: var(--text-2xl);
        margin-bottom: var(--space-2);
        color: var(--color-gray-700);
    }

    .time-remaining {
        background: var(--color-danger-600);
        color: white;
        padding: var(--space-3);
        border-radius: var(--radius-md);
        font-size: var(--text-sm);
        font-weight: var(--font-weight-semibold);
        text-align: center;
        margin-bottom: var(--space-4);
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.7; }
        100% { opacity: 1; }
    }

    .compatibility-notice {
        background: var(--color-warning-50);
        border: 1px solid var(--color-warning-600);
        padding: var(--space-4);
        border-radius: var(--radius-lg);
        margin-bottom: var(--space-6);
    }

    .compatibility-notice p {
        color: var(--color-warning-700);
        margin: 0;
        font-weight: var(--font-weight-medium);
    }

    .stats-summary {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: var(--space-4);
        margin-bottom: var(--space-8);
    }

    .stat-item {
        background: var(--color-gray-50);
        padding: var(--space-4);
        border-radius: var(--radius-lg);
        text-align: center;
        border-left: 4px solid var(--color-primary-600);
    }

    .stat-item.critical {
        border-left-color: var(--color-danger-600);
    }

    .stat-item.high {
        border-left-color: var(--color-warning-600);
    }

    .stat-item.medium {
        border-left-color: var(--color-info-600);
    }

    .stat-number {
        font-size: var(--text-2xl);
        font-weight: var(--font-weight-bold);
        color: var(--color-primary-600);
        margin-bottom: var(--space-1);
    }

    .stat-item.critical .stat-number {
        color: var(--color-danger-600);
    }

    .stat-item.high .stat-number {
        color: var(--color-warning-600);
    }

    .stat-item.medium .stat-number {
        color: var(--color-info-600);
    }

    .stat-label {
        color: var(--color-gray-600);
        font-size: var(--text-sm);
        font-weight: var(--font-weight-medium);
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">
        <i class="fas fa-exclamation-triangle"></i>
        Emergency Blood Requests
    </h1>
    <p class="page-subtitle">View urgent blood requests and help save lives in critical situations</p>
</div>

<div class="content-container">
    <!-- Compatibility Notice -->
    <div class="compatibility-notice">
        <p><i class="fas fa-info-circle"></i> Showing emergency requests that match your blood type ({{ donor.blood_group }}) or universal compatibility</p>
    </div>

    <!-- Statistics Summary -->
    <div class="stats-summary">
        <div class="stat-item critical">
            <div class="stat-number">{{ critical_emergencies|default:"0" }}</div>
            <div class="stat-label">Critical</div>
        </div>
        <div class="stat-item high">
            <div class="stat-number">{{ high_emergencies|default:"0" }}</div>
            <div class="stat-label">High Priority</div>
        </div>
        <div class="stat-item medium">
            <div class="stat-number">{{ medium_emergencies|default:"0" }}</div>
            <div class="stat-label">Medium Priority</div>
        </div>
        <div class="stat-item">
            <div class="stat-number">{{ total_emergencies|default:"0" }}</div>
            <div class="stat-label">Total Active</div>
        </div>
    </div>

    <!-- Emergency Requests List -->
    {% if emergency_requests %}
        {% for request in emergency_requests %}
        <div class="emergency-card {{ request.urgency_level|default:'medium' }}">
            {% if request.required_by %}
            <div class="time-remaining">
                <i class="fas fa-clock"></i>
                Required by: {{ request.required_by|date:"M d, Y H:i" }}
                {% if request.is_urgent %} - URGENT! {% endif %}
            </div>
            {% endif %}

            <div class="emergency-header">
                <div class="emergency-info">
                    <h3>
                        <i class="fas fa-hospital"></i>
                        {{ request.hospital_name }}
                    </h3>
                    <p>{{ request.contact_person }} • {{ request.contact_phone }} • {{ request.location }}</p>
                </div>
                <div class="urgency-badge urgency-{{ request.urgency_level|default:'medium' }}">
                    {{ request.get_urgency_level_display|default:"Medium" }} Priority
                </div>
            </div>
            
            <div class="emergency-details">
                <div class="detail-item">
                    <span class="detail-label">Blood Group Needed</span>
                    <span class="detail-value" style="color: var(--color-danger-600); font-weight: 700;">{{ request.blood_group_needed }}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Units Needed</span>
                    <span class="detail-value" style="color: var(--color-danger-600); font-weight: 700;">{{ request.units_needed }}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Location</span>
                    <span class="detail-value">{{ request.location }}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Contact Person</span>
                    <span class="detail-value">{{ request.contact_person }}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Phone</span>
                    <span class="detail-value">{{ request.contact_phone }}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Posted</span>
                    <span class="detail-value">{{ request.created_at|date:"M d, Y H:i" }}</span>
                </div>
            </div>
            
            {% if request.notes %}
            <div class="detail-item" style="margin-bottom: 1rem;">
                <span class="detail-label">Notes</span>
                <span class="detail-value">{{ request.notes }}</span>
            </div>
            {% endif %}
            
            <div class="emergency-actions">
                <a href="tel:{{ request.contact_phone }}" class="btn btn-small btn-contact">
                    <i class="fas fa-phone"></i> Call Hospital
                </a>
                {% if donor.is_eligible %}
                <a href="{% url 'donor:schedule_donation' %}?emergency={{ request.id }}" class="btn btn-small btn-schedule">
                    <i class="fas fa-calendar-plus"></i> I Can Donate
                </a>
                {% else %}
                <button class="btn btn-small" disabled style="opacity: 0.5; cursor: not-allowed;">
                    <i class="fas fa-ban"></i> Not Eligible Yet
                </button>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="no-emergencies">
            <i class="fas fa-check-circle"></i>
            <h3>No Active Emergencies</h3>
            <p>There are currently no emergency blood requests that match your blood type. Check back later or contact your local blood bank.</p>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Auto-refresh every 2 minutes for critical emergencies
    setInterval(function() {
        if (document.querySelector('.time-remaining')) {
            location.reload();
        }
    }, 120000); // 2 minutes
</script>
{% endblock %}