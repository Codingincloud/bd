{% extends 'donor/base_donor.html' %}
{% load static %}

{% block title %}Donation Centers | Blood Donor Information Management System{% endblock %}

{% block extra_css %}
<style>
    .center-card {
        background: white;
        border: 1px solid var(--color-gray-200);
        border-radius: var(--radius-xl);
        padding: var(--space-6);
        margin-bottom: var(--space-6);
        transition: var(--transition-base);
        border-left: 4px solid var(--color-primary-600);
    }

    .center-card:hover {
        box-shadow: var(--shadow-lg);
        transform: translateY(-2px);
    }

    .center-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: var(--space-4);
        flex-wrap: wrap;
        gap: var(--space-4);
    }

    .center-info h3 {
        color: var(--color-gray-800);
        margin: 0 0 var(--space-2) 0;
        font-size: var(--text-xl);
        display: flex;
        align-items: center;
        gap: var(--space-2);
    }

    .center-info p {
        color: var(--color-gray-600);
        font-size: var(--text-sm);
        margin: 0;
    }

    .center-status {
        padding: var(--space-1) var(--space-3);
        border-radius: var(--radius-xl);
        font-size: var(--text-xs);
        font-weight: var(--font-weight-semibold);
        text-transform: uppercase;
        white-space: nowrap;
    }

    .status-open {
        background: var(--color-success-50);
        color: var(--color-success-600);
    }

    .status-closed {
        background: var(--color-danger-50);
        color: var(--color-danger-600);
    }

    .status-limited {
        background: var(--color-warning-50);
        color: var(--color-warning-600);
    }

    .center-details {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 1.25rem;
        margin: var(--space-4) 0;
        padding: var(--space-4) 0;
        border-top: 1px solid var(--color-gray-100);
        border-bottom: 1px solid var(--color-gray-100);
    }

    .detail-item {
        display: flex;
        flex-direction: column;
        gap: var(--space-1);
    }

    .detail-label {
        font-size: var(--text-xs);
        color: var(--color-gray-500);
        text-transform: uppercase;
        font-weight: var(--font-weight-semibold);
        letter-spacing: 0.5px;
    }

    .detail-value {
        color: var(--color-gray-800);
        font-weight: var(--font-weight-medium);
        word-break: break-word;
    }

    .center-actions {
        display: flex;
        gap: var(--space-3);
        flex-wrap: wrap;
        margin-top: var(--space-4);
    }

    .btn-directions {
        background: var(--color-info-600);
        color: white;
        display: inline-flex;
        align-items: center;
        gap: var(--space-2);
    }

    .btn-directions:hover {
        background: var(--color-info-700);
        color: var(--white);
    }

    .no-centers {
        text-align: center;
        padding: 3rem var(--space-4);
        background: var(--color-gray-50);
        border-radius: var(--radius-lg);
        margin: var(--space-8) 0;
    }

    .no-centers i {
        font-size: 3rem;
        color: var(--color-gray-300);
        margin-bottom: var(--space-4);
    }

    .location-message {
        background: var(--info-blue-light);
        color: var(--info-blue);
        padding: var(--space-4);
        border-radius: var(--radius-lg);
        margin-bottom: var(--space-6);
        display: flex;
        align-items: center;
        gap: var(--space-3);
    }

    .location-message i {
        font-size: var(--text-xl);
    }

    .search-section {
        background: white;
        padding: var(--space-6);
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-sm);
        margin-bottom: var(--space-8);
    }

    .search-title {
        display: flex;
        align-items: center;
        gap: var(--space-3);
        color: var(--color-gray-700);
        margin-top: 0;
        margin-bottom: var(--space-6);
    }

    .search-filters {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: var(--space-4);
        margin-bottom: var(--space-4);
    }

    @media (max-width: 768px) {
        .search-filters {
            grid-template-columns: 1fr;
        }
        
        .center-details {
            grid-template-columns: 1fr 1fr;
        }
    }

    .btn-directions:hover {
        background: #1d4ed8;
    }

    .btn-schedule {
        background: var(--color-success-600);
        color: white;
    }

    .btn-schedule:hover {
        background: #2e7d32;
    }

    .btn-call {
        background: var(--color-warning-600);
        color: white;
    }

    .btn-call:hover {
        background: #d97706;
    }

    .no-centers {
        text-align: center;
        padding: 3rem;
        color: var(--color-gray-500);
    }

    .no-centers i {
        font-size: 4rem;
        color: var(--color-primary-600);
        margin-bottom: var(--space-4);
        opacity: 0.5;
    }

    .no-centers h3 {
        font-size: var(--text-2xl);
        margin-bottom: var(--space-2);
        color: var(--color-gray-700);
    }

    .search-section {
        background: var(--color-gray-50);
        padding: var(--space-6);
        border-radius: var(--radius-lg);
        margin-bottom: var(--space-8);
        border: 1px solid var(--color-gray-200);
    }

    .search-title {
        font-size: 1.1rem;
        font-weight: var(--font-weight-semibold);
        color: var(--color-gray-700);
        margin-bottom: var(--space-4);
        display: flex;
        align-items: center;
        gap: var(--space-2);
    }

    .search-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: var(--space-4);
        align-items: end;
    }

    .search-group {
        display: flex;
        flex-direction: column;
        gap: var(--space-2);
    }

    .search-group label {
        font-weight: var(--font-weight-medium);
        color: var(--color-gray-700);
        font-size: var(--text-sm);
    }

    .search-group input,
    .search-group select {
        padding: var(--space-2);
        border: 1px solid var(--color-gray-300);
        border-radius: var(--radius-md);
        font-size: var(--text-sm);
    }

    .search-group input:focus,
    .search-group select:focus {
        outline: none;
        border-color: var(--color-primary-600);
        box-shadow: 0 0 0 2px rgba(211, 47, 47, 0.1);
    }

    .distance-info {
        background: var(--color-primary-50);
        padding: var(--space-3);
        border-radius: var(--radius-md);
        margin-bottom: var(--space-4);
        border-left: 4px solid var(--color-primary-600);
    }

    .distance-info p {
        color: var(--color-primary-600);
        font-weight: var(--font-weight-medium);
        margin: 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">
        <i class="fas fa-hospital"></i>
        Donation Centers
    </h1>
    <p class="page-subtitle">Find nearby blood donation centers and check their availability</p>
</div>

<div class="content-container">
    <!-- Search Section -->
    <div class="search-section">
        <h3 class="search-title">
            <i class="fas fa-search"></i>
            Find Centers Near You
        </h3>
        <form method="GET" class="search-grid">
            <div class="search-group">
                <label for="city">City</label>
                <input type="text" id="city" name="city" placeholder="Enter your city..." value="{{ request.GET.city }}">
            </div>
            <div class="search-group">
                <label for="radius">Search Radius</label>
                <select id="radius" name="radius">
                    <option value="10" {% if request.GET.radius == '10' %}selected{% endif %}>10 km</option>
                    <option value="25" {% if request.GET.radius == '25' %}selected{% endif %}>25 km</option>
                    <option value="50" {% if request.GET.radius == '50' %}selected{% endif %}>50 km</option>
                    <option value="100" {% if request.GET.radius == '100' %}selected{% endif %}>100 km</option>
                </select>
            </div>
            <div class="search-group">
                <label for="status">Status</label>
                <select id="status" name="status">
                    <option value="">All Centers</option>
                    <option value="open" {% if request.GET.status == 'open' %}selected{% endif %}>Open Now</option>
                    <option value="limited" {% if request.GET.status == 'limited' %}selected{% endif %}>Limited Hours</option>
                </select>
            </div>
            <div class="search-group">
                <button type="submit" class="btn">
                    <i class="fas fa-search"></i> Search
                </button>
            </div>
        </form>
    </div>

    <!-- Distance Info -->
    {% if user_location %}
    <div class="distance-info">
        <p><i class="fas fa-map-marker-alt"></i> Showing centers within {{ search_radius|default:"25" }} km of {{ user_location }}</p>
    </div>
    {% endif %}

    <!-- Centers List -->
    {% if centers %}
        {% for center in centers %}
        <div class="center-card">
            <div class="center-header">
                <div class="center-info">
                    <h3>
                        <i class="fas fa-hospital"></i>
                        {{ center.name }}
                    </h3>
                    <p>{{ center.address }}</p>
                    <small style="color: var(--gray-500);">{{ center.hospital_type }}</small>
                </div>
                <div class="center-status status-open">
                    Open
                </div>
            </div>
            
            <div class="center-details">
                <div class="detail-item">
                    <span class="detail-label">Phone</span>
                    <span class="detail-value">{{ center.phone }}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Hours</span>
                    <span class="detail-value">{{ center.hours }}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Distance</span>
                    <span class="detail-value">{{ center.distance }}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Services</span>
                    <span class="detail-value">
                        {% for service in center.services %}
                            {{ service }}{% if not forloop.last %}, {% endif %}
                        {% endfor %}
                    </span>
                </div>
            </div>
            
            <div class="center-actions">
                <a href="{% url 'donor:schedule_donation' %}?center={{ center.name|urlencode }}&hospital_id={{ center.id }}" class="btn btn-small btn-schedule">
                    <i class="fas fa-calendar-plus"></i> Schedule Here
                </a>
                <a href="tel:{{ center.phone }}" class="btn btn-small btn-call">
                    <i class="fas fa-phone"></i> Call Center
                </a>
                <a href="https://maps.google.com/?q={{ center.address|urlencode }}" target="_blank" class="btn btn-small btn-directions">
                    <i class="fas fa-directions"></i> Get Directions
                </a>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="no-centers">
            <i class="fas fa-hospital"></i>
            <h3>No Centers Found</h3>
            <p>No donation centers match your search criteria. Try expanding your search radius or contact support.</p>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Auto-detect user location and populate city field
    function detectAndPopulateLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                
                // Use basic Nepal city detection based on coordinates
                tryBasicLocationDetection(lat, lng);
            }, function(error) {
                console.log('Geolocation failed:', error);
            });
        }
    }

    function tryBasicLocationDetection(lat, lng) {
        // Basic Nepal city detection based on coordinates
        const nepalCities = [
            { name: 'Kathmandu', lat: 27.7172, lng: 85.3240, radius: 0.2 },
            { name: 'Pokhara', lat: 28.2096, lng: 83.9856, radius: 0.3 },
            { name: 'Lalitpur', lat: 27.6588, lng: 85.3247, radius: 0.15 },
            { name: 'Bhaktapur', lat: 27.6710, lng: 85.4298, radius: 0.15 },
            { name: 'Biratnagar', lat: 26.4525, lng: 87.2718, radius: 0.2 },
            { name: 'Birgunj', lat: 27.0104, lng: 84.8803, radius: 0.2 }
        ];

        for (let city of nepalCities) {
            const distance = Math.sqrt(Math.pow(lat - city.lat, 2) + Math.pow(lng - city.lng, 2));
            if (distance <= city.radius) {
                document.getElementById('city').value = city.name;
                // Don't auto-submit - let user click search manually
                console.log('Location detected: ' + city.name);
                break;
            }
        }
    }

    // Only add the location button - don't auto-detect on load
    document.addEventListener('DOMContentLoaded', function() {
        // Add location button for manual detection
        addLocationButton();
    });

    // Add click handler for manual location detection
    function addLocationButton() {
        const searchSection = document.querySelector('.search-section .search-grid');
        if (searchSection) {
            const locationButton = document.createElement('div');
            locationButton.className = 'search-group';
            locationButton.innerHTML = `
                <label>&nbsp;</label>
                <button type="button" class="btn btn-small" onclick="detectAndPopulateLocation()" style="background: var(--color-success-600); color: white;" title="Click to detect your current location">
                    <i class="fas fa-crosshairs"></i> Use My Location
                </button>
            `;
            searchSection.appendChild(locationButton);
        }
    }
</script>
{% endblock %}