{% extends 'donor/base_donor.html' %}

{% block title %}Schedule Donation | Blood Donor Information Management System{% endblock %}

{% block extra_css %}
<style>
    .form-container {
        background: white;
        padding: var(--space-8);
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-md);
    }

    .eligibility-info {
        background: var(--color-gray-50);
        padding: var(--space-6);
        border-radius: var(--radius-lg);
        margin-bottom: var(--space-8);
        border-left: 4px solid var(--color-success-600);
    }

    .eligibility-info.not-eligible {
        border-left-color: var(--color-warning-600);
        background: var(--color-warning-50);
    }

    .eligibility-info h3 {
        color: var(--color-gray-800);
        margin-bottom: var(--space-4);
        display: flex;
        align-items: center;
        gap: var(--space-2);
    }

    .eligibility-info p {
        margin-bottom: var(--space-2);
        color: var(--color-gray-700);
    }

    .form-group {
        margin-bottom: var(--space-6);
    }

    .form-group label {
        display: block;
        margin-bottom: var(--space-2);
        font-weight: 600;
        color: var(--color-gray-700);
        display: flex;
        align-items: center;
        gap: var(--space-2);
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
        width: 100%;
        padding: var(--space-3);
        border: 2px solid var(--color-gray-200);
        border-radius: var(--radius-lg);
        font-size: var(--text-base);
        transition: border-color 0.3s ease;
    }

    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
        outline: none;
        border-color: var(--color-primary-600);
        box-shadow: 0 0 0 3px var(--color-primary-100);
    }

    .time-slots {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: var(--space-3);
        margin-top: var(--space-2);
    }

    .time-slot {
        padding: var(--space-3);
        border: 2px solid var(--color-gray-200);
        border-radius: var(--radius-lg);
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background: white;
        font-weight: 500;
    }

    .time-slot:hover {
        border-color: var(--color-primary-600);
        background: var(--color-primary-50);
    }

    .time-slot.selected {
        background: var(--color-primary-600);
        color: white;
        border-color: var(--color-primary-600);
    }

    .btn {
        background: var(--color-primary-600);
        color: white;
        border: none;
        padding: var(--space-3) var(--space-6);
        border-radius: var(--radius-lg);
        font-size: var(--text-base);
        font-weight: 600;
        cursor: pointer;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: var(--space-2);
        transition: all 0.3s ease;
    }

    .btn:hover {
        background: var(--color-primary-700);
        transform: translateY(-1px);
    }

    .btn:disabled {
        background: var(--color-gray-400);
        cursor: not-allowed;
        transform: none;
    }

    .btn-secondary {
        background: var(--color-gray-500);
    }

    .btn-secondary:hover {
        background: var(--color-gray-600);
    }

    .not-eligible-message {
        text-align: center;
        padding: var(--space-8);
        background: var(--color-warning-50);
        border: 2px solid var(--color-warning-600);
        border-radius: var(--radius-lg);
        margin-top: var(--space-4);
    }

    .not-eligible-message p {
        color: var(--color-warning-700);
        font-size: var(--text-base);
        margin-bottom: var(--space-4);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--space-2);
    }

    .form-actions {
        display: flex;
        gap: var(--space-4);
        margin-top: var(--space-8);
        flex-wrap: wrap;
    }

    .loading {
        opacity: 0.6;
        pointer-events: none;
    }

    .loading .btn {
        position: relative;
    }

    .loading .btn::after {
        content: '';
        position: absolute;
        width: 16px;
        height: 16px;
        margin: auto;
        border: 2px solid transparent;
        border-top-color: white;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .alert {
        padding: var(--space-4);
        border-radius: var(--radius-lg);
        margin-bottom: var(--space-4);
        display: flex;
        align-items: center;
        gap: var(--space-2);
    }

    .alert-success {
        background: var(--color-success-50);
        color: var(--color-success-700);
        border: 1px solid var(--color-success-600);
    }

    .alert-error {
        background: var(--color-danger-50);
        color: var(--color-danger-700);
        border: 1px solid var(--color-danger-600);
    }

    .alert-warning {
        background: var(--color-warning-50);
        color: var(--color-warning-700);
        border: 1px solid var(--color-warning-600);
    }

    .alert-info {
        background: var(--color-info-50);
        color: var(--color-info-700);
        border: 1px solid var(--color-info-600);
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">
        <i class="fas fa-calendar-plus"></i>
        Schedule Donation
    </h1>
    <p class="page-subtitle">Book your next blood donation appointment at a convenient time and location</p>
</div>

<div class="form-container">
    <!-- Messages -->
    {% if messages %}
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">
            <i class="fas fa-{% if message.tags == 'success' %}check-circle{% elif message.tags == 'error' %}exclamation-circle{% elif message.tags == 'warning' %}exclamation-triangle{% else %}info-circle{% endif %}"></i>
            {{ message }}
        </div>
        {% endfor %}
    {% endif %}

    <!-- Emergency Request Alert -->
    {% if emergency_request %}
    <div class="alert" style="background: var(--color-danger-50); border: 2px solid var(--color-danger-600); border-radius: var(--radius-lg); padding: var(--space-6); margin-bottom: var(--space-6);">
        <div style="display: flex; align-items: start; gap: var(--space-4);">
            <i class="fas fa-ambulance" style="color: var(--color-danger-600); font-size: 2rem;"></i>
            <div style="flex: 1;">
                <h3 style="color: var(--color-danger-700); margin: 0 0 var(--space-2) 0; font-size: var(--text-xl); font-weight: 700;">
                    ðŸš¨ EMERGENCY BLOOD REQUEST
                </h3>
                <p style="margin: var(--space-2) 0; color: var(--color-gray-800); font-size: var(--text-base);">
                    <strong>Blood Type Needed:</strong> {{ emergency_request.blood_type }}<br>
                    <strong>Units Required:</strong> {{ emergency_request.units_needed }}<br>
                    <strong>Hospital:</strong> {{ emergency_request.hospital.name }}{% if emergency_request.hospital.city %}, {{ emergency_request.hospital.city }}{% endif %}<br>
                    {% if emergency_request.contact_phone %}
                    <strong>Contact:</strong> <a href="tel:{{ emergency_request.contact_phone }}" style="color: var(--color-danger-600);">{{ emergency_request.contact_phone }}</a><br>
                    {% endif %}
                    <strong>Urgency:</strong> <span style="color: var(--color-danger-700); font-weight: 700; text-transform: uppercase;">{{ emergency_request.urgency_level }}</span>
                </p>
                <p style="margin: var(--space-3) 0 0 0; padding: var(--space-3); background: white; border-radius: var(--radius-md); color: var(--color-gray-700); font-size: var(--text-sm);">
                    <i class="fas fa-info-circle"></i> You're responding to this emergency. Please schedule your donation as soon as possible to help save a life!
                </p>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="eligibility-info{% if not eligible %} not-eligible{% endif %}">
        <h3>
            <i class="fas fa-{% if eligible %}check-circle{% else %}exclamation-triangle{% endif %}"></i>
            Eligibility Status
        </h3>
        {% if eligible %}
            <p><strong>You are eligible to donate!</strong></p>
            <p>Next eligible date: <strong>{{ next_eligible_date|default:"Now" }}</strong></p>
        {% else %}
            <p><strong>You are not eligible to donate at this time.</strong></p>
            <p>{{ eligibility_message }}</p>
        {% endif %}
    </div>

    {% if eligible %}
    <form method="POST" id="donationForm" class="form-container" novalidate>
        {% csrf_token %}

        <div class="form-group">
            <label for="requested_date">
                <i class="fas fa-calendar"></i> Preferred Date *
            </label>
            <input type="date" 
                   id="requested_date" 
                   name="requested_date" 
                   required
                   aria-required="true"
                   aria-describedby="date-help date-error"
                   min="{{ today|date:'Y-m-d' }}">
            <small id="date-help" style="color: var(--color-gray-500); font-size: 0.875rem; margin-top: 0.5rem; display: block;">
                Select a date from today onwards
            </small>
            <div id="date-error" class="error-message" style="display: none; color: var(--color-danger-600); font-size: 0.875rem; margin-top: 0.5rem;">
                Please select a valid date
            </div>
        </div>

        <div class="form-group">
            <label id="time-label">
                <i class="fas fa-clock"></i> Preferred Time *
            </label>
            <div class="time-slots" role="radiogroup" aria-labelledby="time-label" aria-required="true">
                <div class="time-slot" data-time="09:00" role="radio" tabindex="0" aria-checked="true">9:00 AM</div>
                <div class="time-slot" data-time="10:00" role="radio" tabindex="-1" aria-checked="false">10:00 AM</div>
                <div class="time-slot" data-time="11:00" role="radio" tabindex="-1" aria-checked="false">11:00 AM</div>
                <div class="time-slot" data-time="14:00" role="radio" tabindex="-1" aria-checked="false">2:00 PM</div>
                <div class="time-slot" data-time="15:00" role="radio" tabindex="-1" aria-checked="false">3:00 PM</div>
                <div class="time-slot" data-time="16:00" role="radio" tabindex="-1" aria-checked="false">4:00 PM</div>
            </div>
            <input type="hidden" id="preferred_time" name="preferred_time" value="09:00" aria-hidden="true">
            <div id="time-error" class="error-message" style="display: none; color: var(--color-danger-600); font-size: 0.875rem; margin-top: 0.5rem;">
                Please select a time slot
            </div>
        </div>

        <div class="form-group">
            <label for="hospital">
                <i class="fas fa-hospital"></i> Blood Bank / Hospital *
            </label>
            <select id="hospital" 
                    name="hospital" 
                    required
                    aria-required="true"
                    aria-describedby="center-help hospital-error">
                <option value="">Select a blood bank / hospital...</option>
                {% for hospital in hospitals %}
                <option value="{{ hospital.id }}">
                    {{ hospital.name }} - {{ hospital.city }}, {{ hospital.state }}
                </option>
                {% endfor %}
            </select>
            <small id="center-help" style="color: var(--color-gray-500); font-size: 0.875rem; margin-top: 0.5rem; display: block;">
                Please select where you want to donate blood
            </small>
            <div id="hospital-error" class="error-message" style="display: none; color: var(--color-danger-600); font-size: 0.875rem; margin-top: 0.5rem;">
                Please select a blood bank / hospital
            </div>
        </div>

        <div class="form-group">
            <label for="notes">
                <i class="fas fa-sticky-note"></i> Additional Notes (Optional)
            </label>
            <textarea id="notes" 
                      name="notes" 
                      rows="4"
                      aria-describedby="notes-help"
                      placeholder="Any special requirements or notes..."></textarea>
            <small id="notes-help" style="color: var(--color-gray-500); font-size: 0.875rem; margin-top: 0.5rem; display: block;">
                Share any medical conditions, allergies, or special requests
            </small>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary" id="submitBtn">
                <i class="fas fa-calendar-plus"></i>
                Schedule Donation
            </button>
        </div>
    </form>
    {% else %}
    <div class="not-eligible-message">
        <p>
            <i class="fas fa-info-circle"></i>
            You cannot schedule a donation at this time. Please wait until you become eligible again.
        </p>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Time slot selection
        const timeSlots = document.querySelectorAll('.time-slot');
        const preferredTimeInput = document.getElementById('preferred_time');
        
        // Auto-select first time slot
        if (timeSlots.length > 0) {
            timeSlots[0].classList.add('selected');
        }

        timeSlots.forEach(slot => {
            slot.addEventListener('click', function() {
                timeSlots.forEach(s => {
                    s.classList.remove('selected');
                    s.setAttribute('aria-checked', 'false');
                    s.setAttribute('tabindex', '-1');
                });
                this.classList.add('selected');
                this.setAttribute('aria-checked', 'true');
                this.setAttribute('tabindex', '0');
                preferredTimeInput.value = this.dataset.time;
                
                // Hide error message when time is selected
                const timeError = document.getElementById('time-error');
                if (timeError) {
                    timeError.style.display = 'none';
                }
            });
            
            // Keyboard navigation for time slots
            slot.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    this.click();
                }
            });
        });

        // Form validation and submission
        const form = document.getElementById('donationForm');
        const submitBtn = document.getElementById('submitBtn');
        
        if (form) {
            // Real-time validation for date field
            const dateInput = document.getElementById('requested_date');
            const dateError = document.getElementById('date-error');
            
            dateInput.addEventListener('change', function() {
                if (this.value) {
                    dateError.style.display = 'none';
                    this.setAttribute('aria-invalid', 'false');
                }
            });
            
            // Real-time validation for hospital field
            const hospitalInput = document.getElementById('hospital');
            const hospitalError = document.getElementById('hospital-error');
            
            hospitalInput.addEventListener('change', function() {
                if (this.value) {
                    hospitalError.style.display = 'none';
                    this.setAttribute('aria-invalid', 'false');
                }
            });
            
            form.addEventListener('submit', function(e) {
                const requestedDate = document.getElementById('requested_date').value;
                const preferredTime = document.getElementById('preferred_time').value;
                const hospital = document.getElementById('hospital').value;
                let isValid = true;
                
                // Validate date
                if (!requestedDate) {
                    e.preventDefault();
                    dateError.textContent = 'Please select a preferred date.';
                    dateError.style.display = 'block';
                    dateInput.setAttribute('aria-invalid', 'true');
                    dateInput.focus();
                    isValid = false;
                }
                
                // Validate time
                if (!preferredTime) {
                    e.preventDefault();
                    const timeError = document.getElementById('time-error');
                    timeError.textContent = 'Please select a preferred time.';
                    timeError.style.display = 'block';
                    if (isValid) isValid = false;
                }
                
                // Validate hospital selection
                if (!hospital) {
                    e.preventDefault();
                    hospitalError.textContent = 'Please select a blood bank / hospital.';
                    hospitalError.style.display = 'block';
                    hospitalInput.setAttribute('aria-invalid', 'true');
                    if (isValid) {
                        hospitalInput.focus();
                        isValid = false;
                    }
                }
                
                if (!isValid) {
                    return false;
                }
                
                // Show confirmation dialog with hospital info
                const selectedDate = new Date(requestedDate);
                const formattedDate = selectedDate.toLocaleDateString('en-US', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                // Get selected hospital name
                const hospitalSelect = document.getElementById('hospital');
                const hospitalName = hospitalSelect.options[hospitalSelect.selectedIndex].text;
                
                // Convert 24-hour time to 12-hour format
                const timeDisplay = preferredTime.includes(':') ? 
                    (parseInt(preferredTime.split(':')[0]) > 12 ? 
                        (parseInt(preferredTime.split(':')[0]) - 12) + ':' + preferredTime.split(':')[1] + ' PM' :
                        preferredTime + ' AM') : 
                    preferredTime;
                
                const confirmed = confirm(`Are you sure you want to schedule your blood donation?\n\nDate: ${formattedDate}\nTime: ${timeDisplay}\nLocation: ${hospitalName}`);
                
                if (confirmed) {
                    // Show loading state
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Scheduling...';
                    return true;
                } else {
                    e.preventDefault();
                    return false;
                }
            });
        }
    });
</script>
{% endblock %}