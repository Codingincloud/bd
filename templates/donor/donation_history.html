{% extends 'donor/base_donor.html' %}

{% block title %}Donation History | Blood Donor Information Management System{% endblock %}

{% block extra_css %}
<style>
    .table {
        width: 100%;
        border-collapse: collapse;
        margin-top: var(--space-6);
        background: white;
        border-radius: var(--radius-lg);
        overflow: hidden;
        box-shadow: var(--shadow-sm);
    }

    .table th,
    .table td {
        padding: var(--space-4);
        text-align: left;
        border-bottom: 1px solid var(--color-gray-200);
    }

    .table th {
        background: var(--color-primary-600);
        color: white;
        font-weight: var(--font-weight-semibold);
        text-transform: uppercase;
        font-size: var(--text-sm);
        letter-spacing: 0.05em;
    }

    .table tbody tr:hover {
        background: var(--color-gray-50);
    }

    .table tbody tr:last-child td {
        border-bottom: none;
    }

    .no-data {
        text-align: center;
        padding: var(--space-12);
        color: var(--color-gray-500);
    }

    .no-data i {
        font-size: var(--text-5xl);
        color: var(--color-primary-600);
        margin-bottom: var(--space-4);
        opacity: 0.5;
    }

    .no-data h3 {
        font-size: var(--text-2xl);
        margin-bottom: var(--space-2);
        color: var(--color-gray-700);
    }

    .no-data p {
        margin-bottom: var(--space-8);
    }

    .btn-schedule {
        background: var(--color-primary-600);
        color: white;
        padding: var(--space-3) var(--space-6);
        border-radius: var(--radius-lg);
        text-decoration: none;
        font-weight: var(--font-weight-semibold);
        display: inline-flex;
        align-items: center;
        gap: var(--space-2);
        transition: var(--transition-base);
    }

    .btn-schedule:hover {
        background: var(--color-primary-700);
        transform: translateY(-1px);
        text-decoration: none;
        color: white;
    }

    .stats-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: var(--space-4);
        margin-bottom: var(--space-8);
    }

    .stat-item {
        background: var(--color-gray-50);
        padding: var(--space-4);
        border-radius: var(--radius-lg);
        text-align: center;
        border-left: 4px solid var(--color-primary-600);
    }

    .stat-number {
        font-size: var(--text-3xl);
        font-weight: var(--font-weight-bold);
        color: var(--color-primary-600);
        margin-bottom: var(--space-1);
    }

    .stat-label {
        color: var(--color-gray-600);
        font-size: var(--text-sm);
        font-weight: var(--font-weight-medium);
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">
        <i class="fas fa-history"></i>
        Donation History
    </h1>
    <p class="page-subtitle">Track your complete donation journey and see your impact on saving lives</p>
</div>

<div class="content-container">
    <!-- Messages -->
    {% if messages %}
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }}" style="padding: 1rem; border-radius: 8px; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
            <i class="fas fa-{% if message.tags == 'success' %}check-circle{% elif message.tags == 'error' %}exclamation-circle{% elif message.tags == 'warning' %}exclamation-triangle{% else %}info-circle{% endif %}"></i>
            {{ message }}
        </div>
        {% endfor %}
    {% endif %}

    <!-- Donation Requests Overview -->
    <div class="stats-row" style="margin-bottom: 2rem;">
        <div class="stat-item" style="border-left-color: var(--color-warning-600);">
            <div class="stat-number">{{ pending_requests|length }}</div>
            <div class="stat-label">Pending Approval</div>
        </div>
        <div class="stat-item" style="border-left-color: var(--color-info-600);">
            <div class="stat-number">{{ approved_requests|length }}</div>
            <div class="stat-label">Approved</div>
        </div>
        <div class="stat-item" style="border-left-color: var(--color-success-600);">
            <div class="stat-number">{{ completed_requests|length }}</div>
            <div class="stat-label">Completed</div>
        </div>
        <div class="stat-item" style="border-left-color: var(--color-gray-400);">
            <div class="stat-number">{{ cancelled_requests|length|add:rejected_requests|length }}</div>
            <div class="stat-label">Cancelled/Rejected</div>
        </div>
    </div>

    <!-- Pending Requests Section -->
    {% if pending_requests %}
    <div style="background: var(--color-warning-50); border: 2px solid var(--color-warning-600); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
        <h3 style="color: var(--color-warning-600); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
            <i class="fas fa-clock"></i>
            Pending Approval ({{ pending_requests|length }})
        </h3>
        {% for request in pending_requests %}
        <div style="background: white; padding: 1rem; border-radius: 8px; margin-bottom: 0.5rem; border-left: 4px solid var(--color-warning-600);">
            <div style="font-weight: 600; color: var(--color-gray-800); margin-bottom: 0.25rem;">
                Scheduled for {{ request.requested_date|date:"M d, Y" }} at {{ request.preferred_time }}
            </div>
            <div style="color: var(--color-gray-600); font-size: 0.875rem;">
                Status: Pending Approval ‚Ä¢ Requested on {{ request.created_at|date:"M d, Y" }}
                {% if request.hospital %}<br>üìç Location: {{ request.hospital.name }}, {{ request.hospital.city }}{% endif %}
                {% if request.notes %}<br>Notes: {{ request.notes }}{% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Approved Requests Section -->
    {% if approved_requests %}
    <div style="background: var(--color-info-50); border: 2px solid var(--color-info-600); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
        <h3 style="color: var(--color-info-600); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
            <i class="fas fa-check"></i>
            Approved Appointments ({{ approved_requests|length }})
        </h3>
        {% for request in approved_requests %}
        <div style="background: white; padding: 1rem; border-radius: 8px; margin-bottom: 0.5rem; border-left: 4px solid var(--color-info-600);">
            <div style="font-weight: 600; color: var(--color-gray-800); margin-bottom: 0.25rem;">
                Scheduled for {{ request.requested_date|date:"M d, Y" }} at {{ request.preferred_time }}
            </div>
            <div style="color: var(--color-gray-600); font-size: 0.875rem;">
                Status: Approved ‚Ä¢ Please arrive on time
                {% if request.hospital %}<br>üìç Location: {{ request.hospital.name }}, {{ request.hospital.city }}{% endif %}
                {% if request.notes %}<br>Your Notes: {{ request.notes }}{% endif %}
            </div>
            <div style="background: var(--color-success-50); color: var(--color-success-700); padding: 0.5rem; border-radius: 4px; margin-top: 0.5rem; font-size: 0.875rem;">
                <i class="fas fa-info-circle"></i> Your appointment has been approved! Please arrive at the scheduled time.
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Completed Requests Section -->
    {% if completed_requests %}
    <div style="background: var(--color-success-50); border: 2px solid var(--color-success-600); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
        <h3 style="color: var(--color-success-600); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
            <i class="fas fa-check-double"></i>
            Completed Donations ({{ completed_requests|length }})
        </h3>
        {% for request in completed_requests %}
        <div style="background: white; padding: 1rem; border-radius: 8px; margin-bottom: 0.5rem; border-left: 4px solid var(--color-success-600);">
            <div style="font-weight: 600; color: var(--color-gray-800); margin-bottom: 0.25rem;">
                {{ request.requested_date|date:"M d, Y" }} at {{ request.preferred_time }}
            </div>
            <div style="color: var(--color-gray-600); font-size: 0.875rem;">
                Status: Completed ‚Ä¢ Donation successfully recorded on {{ request.completed_at|date:"M d, Y" }}
                {% if request.hospital %}<br>üìç Location: {{ request.hospital.name }}, {{ request.hospital.city }}{% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Cancelled/Rejected Requests Section -->
    {% if cancelled_requests or rejected_requests %}
    <div style="background: var(--gray-100); border: 2px solid var(--gray-400); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
        <h3 style="color: var(--gray-700); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
            <i class="fas fa-ban"></i>
            Cancelled/Rejected Appointments
        </h3>
        {% for request in cancelled_requests %}
        <div style="background: var(--white); padding: 1rem; border-radius: 8px; margin-bottom: 0.5rem; border-left: 4px solid var(--gray-400);">
            <div style="font-weight: 600; color: var(--gray-800); margin-bottom: 0.25rem;">
                Was scheduled for {{ request.requested_date|date:"M d, Y" }} at {{ request.preferred_time }}
            </div>
            <div style="color: var(--gray-600); font-size: 0.875rem;">
                Status: Cancelled
                {% if request.admin_notes %}<br>Reason: {{ request.admin_notes }}{% endif %}
            </div>
        </div>
        {% endfor %}
        {% for request in rejected_requests %}
        <div style="background: white; padding: 1rem; border-radius: 8px; margin-bottom: 0.5rem; border-left: 4px solid var(--color-danger-600);">
            <div style="font-weight: 600; color: var(--gray-800); margin-bottom: 0.25rem;">
                Was requested for {{ request.requested_date|date:"M d, Y" }} at {{ request.preferred_time }}
            </div>
            <div style="color: var(--gray-600); font-size: 0.875rem;">
                Status: Rejected
                {% if request.rejection_reason %}<br>Reason: {{ request.rejection_reason }}{% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    {% if donation_history %}
        <!-- Statistics -->
        <div class="stats-row">
            <div class="stat-item">
                <div class="stat-number">{{ donation_history|length }}</div>
                <div class="stat-label">Total Donations</div>
            </div>
            <div class="stat-item">
                <div class="stat-number">
                    {% for donation in donation_history %}
                        {% if forloop.first %}{{ donation.units_donated }}{% endif %}
                    {% endfor %}
                </div>
                <div class="stat-label">Units Donated</div>
            </div>
            <div class="stat-item">
                <div class="stat-number">
                    {% for donation in donation_history %}
                        {% if forloop.first %}{{ donation.donation_date|date:"Y" }}{% endif %}
                    {% endfor %}
                </div>
                <div class="stat-label">First Donation Year</div>
            </div>
        </div>

        <!-- Donation History Table -->
        <table class="table">
            <thead>
                <tr>
                    <th><i class="fas fa-calendar"></i> Date</th>
                    <th><i class="fas fa-hospital"></i> Center</th>
                    <th><i class="fas fa-tint"></i> Units</th>
                    <th><i class="fas fa-heartbeat"></i> Blood Pressure</th>
                    <th><i class="fas fa-vial"></i> Hemoglobin</th>
                    <th><i class="fas fa-sticky-note"></i> Notes</th>
                </tr>
            </thead>
            <tbody>
                {% for donation in donation_history %}
                <tr>
                    <td>
                        <strong>{{ donation.donation_date|date:"M d, Y" }}</strong><br>
                        <small style="color: var(--gray-500);">{{ donation.donation_date|date:"l" }}</small>
                    </td>
                    <td>{{ donation.donation_center_name|default:"Main Center" }}</td>
                    <td>
                        <span style="color: var(--color-primary-600); font-weight: 600;">
                            {{ donation.units_donated }}L
                        </span>
                    </td>
                    <td>{{ donation.blood_pressure|default:"N/A" }}</td>
                    <td>{{ donation.hemoglobin_level|default:"N/A" }}</td>
                    <td>{{ donation.notes|default:"‚Äî" }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <div class="no-data">
            <i class="fas fa-history"></i>
            <h3>No Donation History Found</h3>
            <p>You haven't made any donations yet. Start your journey of saving lives today!</p>
            <a href="{% url 'donor:schedule_donation' %}" class="btn-schedule">
                <i class="fas fa-calendar-plus"></i>
                Schedule Your First Donation
            </a>
        </div>
    {% endif %}
</div>
{% endblock %}