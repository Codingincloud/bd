{% extends 'donor/base_donor.html' %}

{% block title %}All Notifications - Blood Donation System{% endblock %}

{% block extra_css %}
<style>
        .notifications-page .container {
            max-width: 1000px;
        }

        .notifications-container {
            padding: 20px;
        }

        .notifications-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f1f3f4;
        }

        .notifications-title {
            font-size: var(--text-2xl);
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .mark-all-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: var(--radius-lg);
            cursor: pointer;
            font-weight: var(--font-weight-medium);
            transition: var(--transition-base);
        }

        .mark-all-btn:hover {
            background: #218838;
        }

        .notification-item {
            display: flex;
            align-items: flex-start;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            transition: var(--transition-base);
            cursor: pointer;
        }

        .notification-item:hover {
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .notification-item.unread {
            background: linear-gradient(135deg, #e7f3ff 0%, #f0f8ff 100%);
            border-left: 4px solid #007bff;
        }

        .notification-icon {
            margin-right: 15px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .notification-icon.success {
            background: #d4edda;
            color: #28a745;
        }

        .notification-icon.warning {
            background: #fff3cd;
            color: #ffc107;
        }

        .notification-icon.danger {
            background: #f8d7da;
            color: #dc3545;
        }

        .notification-icon.info {
            background: #d1ecf1;
            color: #17a2b8;
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-weight: var(--font-weight-semibold);
            color: #212529;
            margin-bottom: var(--space-2);
            font-size: 1.1rem;
        }

        .notification-message {
            color: #6c757d;
            line-height: 1.5;
            margin-bottom: 10px;
        }

        .notification-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            color: #adb5bd;
        }

        .notification-time {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .notification-status {
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: var(--font-weight-medium);
        }

        .notification-status.read {
            color: #28a745;
        }

        .notification-status.unread {
            color: #007bff;
        }

        .no-notifications {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .no-notifications i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .no-notifications h3 {
            margin-bottom: 10px;
            color: #495057;
        }

        .filter-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .filter-tab {
            padding: 10px 20px;
            border: 2px solid #dee2e6;
            background: white;
            border-radius: 25px;
            cursor: pointer;
            transition: var(--transition-base);
            font-weight: var(--font-weight-medium);
        }

        .filter-tab.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .filter-tab:hover {
            border-color: #007bff;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }

            .header {
                padding: 20px;
            }

            .header h1 {
                font-size: var(--text-2xl);
            }

            .notifications-header {
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
            }

            .filter-tabs {
                flex-wrap: wrap;
            }

            .notification-item {
                padding: 15px;
            }
        }
    </style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">
        <i class="fas fa-bell"></i>
        All Notifications
    </h1>
    <p class="page-subtitle">Stay updated with your blood donation activities</p>
</div>

<div class="content-container">

        <div class="notifications-container">
            <div class="notifications-header">
                <div class="notifications-title">
                    <i class="fas fa-list"></i>
                    Your Notifications
                    {% if unread_count > 0 %}
                        <span style="background: #dc3545; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem;">
                            {{ unread_count }} unread
                        </span>
                    {% endif %}
                </div>
                {% if unread_count > 0 %}
                    <button class="mark-all-btn" onclick="markAllAsRead()">
                        <i class="fas fa-check-double"></i> Mark All as Read
                    </button>
                {% endif %}
            </div>

            <div class="filter-tabs">
                <div class="filter-tab active" onclick="filterNotifications('all')">
                    All Notifications
                </div>
                <div class="filter-tab" onclick="filterNotifications('unread')">
                    Unread Only
                </div>
                <div class="filter-tab" onclick="filterNotifications('read')">
                    Read Only
                </div>
            </div>

            <div class="notifications-list">
                {% if user_notifications %}
                    {% for notification in user_notifications %}
                        <div class="notification-item {% if not notification.is_read %}unread{% endif %}"
                             data-notification-id="{{ notification.id }}"
                             data-read-status="{% if notification.is_read %}read{% else %}unread{% endif %}"
                             onclick="{% if not notification.is_read %}markAsRead('{{ notification.id }}'){% endif %}">
                            <div class="notification-icon {% if notification.notification_type == 'donation_scheduled' or notification.notification_type == 'donation_completed' %}success{% elif notification.notification_type == 'donation_reminder' %}warning{% elif notification.notification_type == 'emergency_request' %}danger{% else %}info{% endif %}">
                                {% if notification.notification_type == 'donation_scheduled' %}
                                    <i class="fas fa-calendar-check"></i>
                                {% elif notification.notification_type == 'donation_reminder' %}
                                    <i class="fas fa-clock"></i>
                                {% elif notification.notification_type == 'donation_completed' %}
                                    <i class="fas fa-heart"></i>
                                {% elif notification.notification_type == 'emergency_request' %}
                                    <i class="fas fa-exclamation-triangle"></i>
                                {% elif notification.notification_type == 'location_updated' %}
                                    <i class="fas fa-map-marker-alt"></i>
                                {% elif notification.notification_type == 'profile_updated' %}
                                    <i class="fas fa-user-edit"></i>
                                {% elif notification.notification_type == 'eligibility_restored' %}
                                    <i class="fas fa-check-circle"></i>
                                {% else %}
                                    <i class="fas fa-info-circle"></i>
                                {% endif %}
                            </div>
                            <div class="notification-content">
                                <div class="notification-title">{{ notification.title }}</div>
                                <div class="notification-message">{{ notification.message }}</div>
                                <div class="notification-meta">
                                    <div class="notification-time">
                                        <i class="fas fa-clock"></i>
                                        {{ notification.created_at|timesince }} ago
                                    </div>
                                    <div class="notification-status {% if notification.is_read %}read{% else %}unread{% endif %}">
                                        {% if notification.is_read %}
                                            <i class="fas fa-check-circle"></i> Read
                                        {% else %}
                                            <i class="fas fa-circle"></i> Unread
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="no-notifications">
                        <i class="fas fa-bell-slash"></i>
                        <h3>No Notifications Yet</h3>
                        <p>You'll see your blood donation updates and important messages here.</p>
                    </div>
                {% endif %}
            </div>
        </div>
</div>
</div>
{% endblock %}

{% block extra_js %}
<script>
        function markAsRead(notificationId) {
            fetch(`/donor/notifications/mark-read/${notificationId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Mark notification as read (keep it but change styling)
                    const notificationItem = document.querySelector(`[data-notification-id="${notificationId}"]`);
                    if (notificationItem) {
                        notificationItem.classList.remove('unread');
                        notificationItem.setAttribute('data-read-status', 'read');
                        notificationItem.onclick = null; // Remove click handler

                        const statusElement = notificationItem.querySelector('.notification-status');
                        statusElement.className = 'notification-status read';
                        statusElement.innerHTML = 'Read';

                        updateUnreadCount();
                    }
                }
            })
            .catch(error => console.error('Error:', error));
        }

        function markAllAsRead() {
            fetch('/donor/notifications/mark-all-read/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Mark all unread notifications as read (keep them but change styling)
                    document.querySelectorAll('.notification-item.unread').forEach(item => {
                        item.classList.remove('unread');
                        item.setAttribute('data-read-status', 'read');
                        item.onclick = null; // Remove click handler

                        const statusElement = item.querySelector('.notification-status');
                        statusElement.className = 'notification-status read';
                        statusElement.innerHTML = 'Read';
                    });

                    // Update UI
                    const markAllBtn = document.querySelector('.mark-all-btn');
                    if (markAllBtn) markAllBtn.style.display = 'none';
                    updateUnreadCount();
                }
            })
            .catch(error => console.error('Error:', error));
        }



        function filterNotifications(filter) {
            const tabs = document.querySelectorAll('.filter-tab');
            const notifications = document.querySelectorAll('.notification-item');

            // Update active tab
            tabs.forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            // Filter notifications
            notifications.forEach(notification => {
                const readStatus = notification.getAttribute('data-read-status');

                if (filter === 'all') {
                    notification.style.display = 'flex';
                } else if (filter === 'unread' && readStatus === 'unread') {
                    notification.style.display = 'flex';
                } else if (filter === 'read' && readStatus === 'read') {
                    notification.style.display = 'flex';
                } else {
                    notification.style.display = 'none';
                }
            });
        }

        function updateUnreadCount() {
            const unreadCount = document.querySelectorAll('.notification-item[data-read-status="unread"]').length;
            const unreadBadge = document.querySelector('.notifications-title span');

            if (unreadCount === 0 && unreadBadge) {
                unreadBadge.remove();
            } else if (unreadBadge) {
                unreadBadge.textContent = `${unreadCount} unread`;
            }
        }

        function checkIfNoNotifications() {
            const notificationsList = document.querySelector('.notifications-list');
            const notificationItems = document.querySelectorAll('.notification-item');

            if (notificationItems.length === 0) {
                notificationsList.innerHTML = `
                    <div class="no-notifications">
                        <i class="fas fa-bell-slash"></i>
                        <h3>No Notifications</h3>
                        <p>All caught up! You have no unread notifications.</p>
                    </div>
                `;
            }
        }
</script>
{% endblock %}
