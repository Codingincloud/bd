{% extends 'admin_panel/base_admin.html' %}

{% block title %}Donor Management | Blood Donor Information Management System{% endblock %}

{% block extra_css %}
    <style>
    .filters-section {
        background: var(--color-gray-50);
        padding: var(--space-6);
        border-radius: var(--radius-lg);
        margin-bottom: var(--space-8);
        border: 1px solid var(--color-gray-200);
    }

    .filters-title {
        font-size: var(--text-lg);
        font-weight: var(--font-weight-semibold);
        color: var(--color-gray-700);
        margin-bottom: var(--space-4);
        display: flex;
        align-items: center;
        gap: var(--space-2);
    }

    .filters-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: var(--space-4);
        align-items: end;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
        gap: var(--space-2);
    }

    .filter-group label {
        font-weight: var(--font-weight-medium);
        color: var(--color-gray-700);
        font-size: var(--text-sm);
    }

    .filter-group select,
    .filter-group input {
        padding: var(--space-2);
        border: 1px solid var(--color-gray-300);
        border-radius: var(--radius-md);
        font-size: var(--text-sm);
    }

    .filter-group select:focus,
    .filter-group input:focus {
        outline: none;
        border-color: var(--color-primary-600);
        box-shadow: 0 0 0 2px rgba(211, 47, 47, 0.1);
    }

    .donor-card {
        background: white;
        border: 1px solid var(--color-gray-200);
        border-radius: var(--radius-lg);
        padding: var(--space-6);
        margin-bottom: var(--space-4);
        transition: var(--transition-base);
    }

    .donor-card:hover {
        box-shadow: var(--shadow-md);
        transform: translateY(-1px);
    }

    .donor-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: var(--space-4);
    }

    .donor-info h3 {
        color: var(--color-gray-800);
        margin-bottom: var(--space-1);
        font-size: var(--text-xl);
    }

    .donor-info p {
        color: var(--color-gray-600);
        font-size: var(--text-sm);
    }

    .donor-status {
        padding: var(--space-1) var(--space-3);
        border-radius: var(--radius-xl);
        font-size: var(--text-xs);
            font-weight: var(--font-weight-semibold);
        text-transform: uppercase;
    }

    .donor-details {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: var(--space-4);
        margin-bottom: var(--space-4);
    }

    .detail-item {
        display: flex;
        flex-direction: column;
        gap: var(--space-1);
    }

    .detail-label {
        font-size: var(--text-xs);
        color: var(--color-gray-500);
        text-transform: uppercase;
        font-weight: var(--font-weight-semibold);
    }

    .detail-value {
        color: var(--color-gray-800);
        font-weight: var(--font-weight-medium);
    }

    .donor-actions {
        display: flex;
        gap: var(--space-2);
        flex-wrap: wrap;
    }

    .btn-view {
        background: var(--color-info-600);
        color: white;
    }

    .btn-view:hover {
        background: #1d4ed8;
    }

    .btn-edit {
        background: var(--color-warning-600);
        color: white;
    }

    .btn-edit:hover {
        background: #d97706;
    }

    .btn-deactivate {
        background: var(--color-danger-600);
        color: white;
    }

    .btn-deactivate:hover {
        background: #dc2626;
    }

    .pagination {
            display: flex;
        justify-content: center;
            align-items: center;
        gap: var(--space-2);
        margin-top: var(--space-8);
    }

    .pagination a,
    .pagination span {
        padding: var(--space-2) var(--space-3);
        border: 1px solid var(--color-gray-300);
        border-radius: var(--radius-md);
        text-decoration: none;
        color: var(--color-gray-700);
        font-size: var(--text-sm);
    }

    .pagination a:hover {
        background: var(--color-primary-600);
        color: white;
        border-color: var(--color-primary-600);
    }

    .pagination .current {
        background: var(--color-primary-600);
        color: white;
        border-color: var(--color-primary-600);
        }

        .no-donors {
            text-align: center;
        padding: var(--space-12);
        color: var(--color-gray-500);
    }

    .no-donors i {
        font-size: var(--text-5xl);
        color: var(--color-primary-600);
        margin-bottom: var(--space-4);
        opacity: 0.5;
    }

    .no-donors h3 {
        font-size: var(--text-2xl);
        margin-bottom: var(--space-2);
        color: var(--color-gray-700);
    }

    .stats-summary {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: var(--space-4);
        margin-bottom: var(--space-8);
    }

    .stat-item {
        background: var(--color-gray-50);
        padding: var(--space-4);
        border-radius: var(--radius-lg);
        text-align: center;
        border-left: 4px solid var(--color-primary-600);
    }

    .stat-number {
        font-size: var(--text-2xl);
        font-weight: var(--font-weight-bold);
        color: var(--color-primary-600);
        margin-bottom: var(--space-1);
    }

    .stat-label {
        color: var(--color-gray-600);
        font-size: var(--text-sm);
        font-weight: var(--font-weight-medium);
        }
    </style>
{% endblock %}

{% block content %}
<div class="page-header">
    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
        <div>
            <h1 class="page-title">
                <i class="fas fa-users"></i>
                Donor Management
            </h1>
            <p class="page-subtitle">View and manage donor profiles, search by blood group or location</p>
        </div>
        <a href="{% url 'admin_panel:export_donors' %}{% if request.GET %}?{{ request.GET.urlencode }}{% endif %}" class="btn" style="background: var(--color-success-600); color: white; display: flex; align-items: center; gap: var(--space-2);">
            <i class="fas fa-file-download"></i> Export to CSV
        </a>
    </div>
</div>

<div class="content-container">
    <!-- Statistics Summary -->
    <div class="stats-summary">
        <div class="stat-item">
            <div class="stat-number">{{ total_donors|default:"0" }}</div>
            <div class="stat-label">Total Donors</div>
        </div>
        <div class="stat-item">
            <div class="stat-number">{{ active_donors|default:"0" }}</div>
            <div class="stat-label">Active Donors</div>
        </div>
        <div class="stat-item">
            <div class="stat-number">{{ eligible_donors|default:"0" }}</div>
            <div class="stat-label">Eligible Now</div>
        </div>
        <div class="stat-item">
            <div class="stat-number">{{ recent_donors|default:"0" }}</div>
            <div class="stat-label">New This Month</div>
        </div>
                        </div>
                        
    <!-- Search and Filters -->
    <div class="filters-section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-4);">
            <h3 class="filters-title" style="margin: 0;">
                <i class="fas fa-filter"></i>
                Search & Filter Donors
            </h3>
            {% if request.GET.search or request.GET.blood_group or request.GET.city or request.GET.status %}
            <div style="display: flex; gap: var(--space-3); align-items: center;">
                <span style="color: var(--color-gray-600); font-size: var(--text-sm);">
                    <i class="fas fa-check-circle" style="color: var(--color-success-600);"></i>
                    {{ donors|length }} result{{ donors|length|pluralize }} found
                </span>
                <a href="{% url 'admin_panel:donor_tracking' %}" class="btn" style="background: var(--color-gray-100); color: var(--color-gray-700); padding: var(--space-2) var(--space-4); font-size: var(--text-sm);">
                    <i class="fas fa-times"></i> Clear Filters
                </a>
            </div>
            {% endif %}
        </div>
        <form method="GET" class="filters-grid">
            <div class="filter-group">
                <label for="search">Search</label>
                <input type="text" id="search" name="search" placeholder="Name, email, or phone..." value="{{ request.GET.search }}" style="grid-column: span 2;">
            </div>
            <div class="filter-group">
                            <label for="blood_group">Blood Group</label>
                <select id="blood_group" name="blood_group">
                                <option value="">All Blood Groups</option>
                    <option value="A+" {% if request.GET.blood_group == 'A+' %}selected{% endif %}>A+</option>
                    <option value="A-" {% if request.GET.blood_group == 'A-' %}selected{% endif %}>A-</option>
                    <option value="B+" {% if request.GET.blood_group == 'B+' %}selected{% endif %}>B+</option>
                    <option value="B-" {% if request.GET.blood_group == 'B-' %}selected{% endif %}>B-</option>
                    <option value="AB+" {% if request.GET.blood_group == 'AB+' %}selected{% endif %}>AB+</option>
                    <option value="AB-" {% if request.GET.blood_group == 'AB-' %}selected{% endif %}>AB-</option>
                    <option value="O+" {% if request.GET.blood_group == 'O+' %}selected{% endif %}>O+</option>
                    <option value="O-" {% if request.GET.blood_group == 'O-' %}selected{% endif %}>O-</option>
                            </select>
                        </div>
            <div class="filter-group">
                            <label for="city">City</label>
                <input type="text" id="city" name="city" placeholder="Enter city..." value="{{ request.GET.city }}">
                        </div>
            <div class="filter-group">
                <label for="status">Status</label>
                <select id="status" name="status">
                    <option value="">All Status</option>
                    <option value="active" {% if request.GET.status == 'active' %}selected{% endif %}>Active</option>
                    <option value="inactive" {% if request.GET.status == 'inactive' %}selected{% endif %}>Inactive</option>
                    <option value="eligible" {% if request.GET.status == 'eligible' %}selected{% endif %}>Eligible</option>
                    <option value="not_eligible" {% if request.GET.status == 'not_eligible' %}selected{% endif %}>Not Eligible</option>
                            </select>
                        </div>
            <div class="filter-group">
                <button type="submit" class="btn">
                    <i class="fas fa-search"></i> Search
                </button>
                        </div>
        </form>
                        </div>

    <!-- Donors List -->
    {% if donors %}
        {% for donor in donors %}
        <div class="donor-card">
            <div class="donor-header">
                <div class="donor-info">
                    <h3>{{ donor.name|default:"N/A" }}</h3>
                    <p>{{ donor.user.email|default:"No email" }} â€¢ ID: {{ donor.id }}</p>
                        </div>
                <div class="donor-status {% if donor.is_eligible %}status-active{% else %}status-inactive{% endif %}">
                    {% if donor.is_eligible %}Active{% else %}Inactive{% endif %}
                    </div>
            </div>

            <div class="donor-details">
                <div class="detail-item">
                    <span class="detail-label">Blood Group</span>
                    <span class="detail-value">{{ donor.blood_group }}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Phone</span>
                    <span class="detail-value">{{ donor.phone_number|default:"N/A" }}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Location</span>
                    <span class="detail-value">{{ donor.city|default:"N/A" }}, {{ donor.state|default:"N/A" }}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Last Donation</span>
                    <span class="detail-value">{{ donor.last_donation_date|date:"M d, Y"|default:"Never" }}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Total Donations</span>
                    <span class="detail-value">{{ donor.donation_count|default:"0" }}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Weight</span>
                    <span class="detail-value">{{ donor.weight|default:"N/A" }} kg</span>
                </div>
            </div>

            <div class="donor-actions">
                <a href="{% url 'admin_panel:donor_detail' donor.id %}" class="btn btn-small btn-view">
                    <i class="fas fa-eye"></i> View Details
                </a>
                <a href="{% url 'admin_panel:edit_donor' donor.id %}" class="btn btn-small btn-edit">
                    <i class="fas fa-edit"></i> Edit
                </a>
                {% if donor.is_eligible %}
                <button class="btn btn-small btn-deactivate" onclick="deactivateDonor({{ donor.id }})">
                    <i class="fas fa-ban"></i> Deactivate
                </button>
                {% else %}
                <button class="btn btn-small btn-success" onclick="activateDonor({{ donor.id }})">
                    <i class="fas fa-check"></i> Activate
                </button>
                {% endif %}
                                        </div>
                                    </div>
        {% endfor %}

        <!-- Pagination -->
        {% if donors.has_other_pages %}
        <div class="pagination">
            {% if donors.has_previous %}
                <a href="?page=1{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.blood_group %}&blood_group={{ request.GET.blood_group }}{% endif %}{% if request.GET.city %}&city={{ request.GET.city }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}">&laquo; First</a>
                <a href="?page={{ donors.previous_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.blood_group %}&blood_group={{ request.GET.blood_group }}{% endif %}{% if request.GET.city %}&city={{ request.GET.city }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}">Previous</a>
                                            {% endif %}

            <span class="current">
                Page {{ donors.number }} of {{ donors.paginator.num_pages }}
            </span>

            {% if donors.has_next %}
                <a href="?page={{ donors.next_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.blood_group %}&blood_group={{ request.GET.blood_group }}{% endif %}{% if request.GET.city %}&city={{ request.GET.city }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}">Next</a>
                <a href="?page={{ donors.paginator.num_pages }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.blood_group %}&blood_group={{ request.GET.blood_group }}{% endif %}{% if request.GET.city %}&city={{ request.GET.city }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}">Last &raquo;</a>
                                        {% endif %}
                                        </div>
                                    {% endif %}
                                    {% else %}
        <div class="no-donors">
            <i class="fas fa-users"></i>
            <h3>No Donors Found</h3>
            <p>No donors match your search criteria. Try adjusting your filters or search terms.</p>
        </div>
    {% endif %}
    </div>
{% endblock %}

{% block extra_js %}
<script>
    function deactivateDonor(donorId) {
        if (confirm('Are you sure you want to deactivate this donor?')) {
            fetch(`/admin-panel/donor/${donorId}/deactivate/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error deactivating donor');
            });
        }
    }

    function activateDonor(donorId) {
        if (confirm('Are you sure you want to activate this donor?')) {
            fetch(`/admin-panel/donor/${donorId}/activate/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error activating donor');
            });
        }
    }
</script>
{% endblock %}