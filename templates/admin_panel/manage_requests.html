{% extends 'admin_panel/base_admin.html' %}

{% block title %}Manage Requests | Blood Donor Information Management System{% endblock %}

{% block extra_css %}
<style>
    .request-card {
        background: white;
        border: 1px solid var(--color-gray-200);
        border-radius: var(--radius-lg);
        padding: var(--space-6);
        margin-bottom: var(--space-4);
        transition: var(--transition-base);
    }

    .request-card:hover {
        box-shadow: var(--shadow-md);
        transform: translateY(-1px);
    }

    .request-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: var(--space-4);
    }

    .request-info h3 {
        color: var(--color-gray-800);
        margin-bottom: var(--space-1);
        font-size: var(--text-xl);
    }

    .request-info p {
        color: var(--color-gray-600);
        font-size: var(--text-sm);
    }

    .request-status {
        padding: var(--space-1) var(--space-3);
        border-radius: var(--radius-xl);
        font-size: var(--text-xs);
        font-weight: var(--font-weight-semibold);
        text-transform: uppercase;
    }

    .request-details {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: var(--space-4);
        margin-bottom: var(--space-4);
    }

    .detail-item {
        display: flex;
        flex-direction: column;
        gap: var(--space-1);
    }

    .detail-label {
        font-size: var(--text-xs);
        color: var(--color-gray-500);
        text-transform: uppercase;
        font-weight: var(--font-weight-semibold);
    }

    .detail-value {
        color: var(--color-gray-800);
        font-weight: var(--font-weight-medium);
    }

    .request-actions {
        display: flex;
        gap: var(--space-2);
        flex-wrap: wrap;
    }

    .btn-approve {
        background: var(--color-success-600);
        color: white;
    }

    .btn-approve:hover {
        background: #2e7d32;
    }

    .btn-reject {
        background: var(--color-danger-600);
        color: white;
    }

    .btn-reject:hover {
        background: #dc2626;
    }

    .btn-view {
        background: var(--color-info-600);
        color: white;
    }

    .btn-view:hover {
        background: #1d4ed8;
    }

    .no-requests {
        text-align: center;
        padding: var(--space-12);
        color: var(--color-gray-500);
    }

    .no-requests i {
        font-size: var(--text-5xl);
        color: var(--color-primary-600);
        margin-bottom: var(--space-4);
        opacity: 0.5;
    }

    .no-requests h3 {
        font-size: var(--text-2xl);
        margin-bottom: var(--space-2);
        color: var(--color-gray-700);
    }

    .stats-summary {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: var(--space-4);
        margin-bottom: var(--space-8);
    }

    .stat-item {
        background: var(--color-gray-50);
        padding: var(--space-4);
        border-radius: var(--radius-lg);
        text-align: center;
        border-left: 4px solid var(--color-primary-600);
    }

    .stat-number {
        font-size: var(--text-2xl);
        font-weight: var(--font-weight-bold);
        color: var(--color-primary-600);
        margin-bottom: var(--space-1);
    }

    .stat-label {
        color: var(--color-gray-600);
        font-size: var(--text-sm);
        font-weight: var(--font-weight-medium);
    }

    .priority-high {
        border-left-color: var(--color-danger-600);
    }

    .priority-medium {
        border-left-color: var(--color-warning-600);
    }

    .priority-low {
        border-left-color: var(--color-success-600);
    }
</style>
{% endblock %}

{% block content %}
{% csrf_token %}
<div class="page-header">
    <h1 class="page-title">
        <i class="fas fa-clipboard-list"></i>
        Manage Donation Requests
    </h1>
    <p class="page-subtitle">Review and manage donation appointment requests from donors</p>
</div>

<div class="content-container">
    <!-- Statistics Summary -->
    <div class="stats-summary">
        <div class="stat-item">
            <div class="stat-number">{{ total_requests|default:"0" }}</div>
            <div class="stat-label">Total Requests</div>
        </div>
        <div class="stat-item">
            <div class="stat-number">{{ pending_requests|default:"0" }}</div>
            <div class="stat-label">Pending</div>
        </div>
        <div class="stat-item">
            <div class="stat-number">{{ approved_requests|default:"0" }}</div>
            <div class="stat-label">Approved</div>
        </div>
        <div class="stat-item">
            <div class="stat-number" style="color: var(--color-success-600);">{{ completed_requests|default:"0" }}</div>
            <div class="stat-label">Completed</div>
        </div>
        <div class="stat-item">
            <div class="stat-number" style="color: var(--color-warning-600);">{{ cancelled_requests|default:"0" }}</div>
            <div class="stat-label">Cancelled</div>
        </div>
        <div class="stat-item">
            <div class="stat-number" style="color: var(--color-danger-600);">{{ rejected_requests|default:"0" }}</div>
            <div class="stat-label">Rejected</div>
        </div>
    </div>

    <!-- Search and Filters -->
    <div class="search-bar">
        <input type="text" class="search-input" placeholder="Search by donor name or request ID..." id="requestSearch">
        <select class="search-input" id="requestStatusFilter">
            <option value="">All Status</option>
            <option value="pending">Pending</option>
            <option value="approved">Approved</option>
            <option value="completed">Completed</option>
            <option value="cancelled">Cancelled</option>
            <option value="rejected">Rejected</option>
        </select>
        <select class="search-input" id="requestPriorityFilter">
            <option value="">All Priorities</option>
            <option value="high">High Priority</option>
            <option value="medium">Medium Priority</option>
            <option value="low">Low Priority</option>
        </select>
        <button class="search-btn" onclick="searchRequests()">
            <i class="fas fa-search"></i> Search
        </button>
    </div>

    <!-- Requests List -->
    {% if donation_requests %}
        {% for request in donation_requests %}
        <div class="request-card priority-{{ request.priority|default:'medium' }}">
            <div class="request-header">
                <div class="request-info">
                    <h3>{{ request.donor.name|default:"N/A" }}</h3>
                    <p>{{ request.donor.user.email|default:"No email" }} • Request ID: {{ request.id }}</p>
                </div>
                <div class="request-status {% if request.status == 'pending' %}status-pending{% elif request.status == 'approved' %}status-active{% else %}status-inactive{% endif %}">
                    {{ request.get_status_display }}
                </div>
            </div>
            
            <div class="request-details">
                <div class="detail-item">
                    <span class="detail-label">Blood Group</span>
                    <span class="detail-value">{{ request.donor.blood_group }}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Requested Date</span>
                    <span class="detail-value">{{ request.requested_date|date:"M d, Y" }}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Preferred Time</span>
                    <span class="detail-value">{{ request.preferred_time }}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Donation Center</span>
                    <span class="detail-value">
                        {% if request.donation_center %}
                            {{ request.donation_center.name }}, {{ request.donation_center.city }}
                        {% else %}
                            <span style="color: var(--gray-400);">Not specified</span>
                        {% endif %}
                    </span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Submitted</span>
                    <span class="detail-value">{{ request.created_at|date:"M d, Y H:i" }}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Last Donation</span>
                    <span class="detail-value">{{ request.donor.last_donation_date|date:"M d, Y"|default:"Never" }}</span>
                </div>
            </div>
            
            {% if request.notes %}
            <div class="detail-item" style="margin-bottom: 1rem;">
                <span class="detail-label">Notes</span>
                <span class="detail-value">{{ request.notes }}</span>
            </div>
            {% endif %}
            
            <div class="request-actions">
                {% if request.status == 'pending' %}
                    <button class="btn btn-success btn-small" onclick="confirmApproval('{{ request.id }}')">
                        <i class="fas fa-check"></i> Approve
                    </button>
                    <button class="btn btn-small btn-reject" onclick="confirmReject('{{ request.id }}')">
                        <i class="fas fa-times"></i> Reject
                    </button>
                {% elif request.status == 'approved' %}
                    <button class="btn btn-success btn-small" onclick="confirmComplete('{{ request.id }}')">
                        <i class="fas fa-check-double"></i> Mark as Completed
                    </button>
                    <button class="btn btn-small" style="background: var(--color-warning-600);" onclick="confirmCancel('{{ request.id }}')">
                        <i class="fas fa-ban"></i> Cancel Appointment
                    </button>
                    <span style="color: var(--color-success-600); font-size: 0.875rem; display: block; margin-top: 0.5rem;">
                        <i class="fas fa-clock"></i> Approved on {{ request.updated_at|date:"M d, Y H:i" }}</span>
                {% else %}
                    <span style="color: var(--gray-500); font-size: 0.875rem;">
                        {{ request.get_status_display }} on {{ request.updated_at|date:"M d, Y" }}
                    </span>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="no-requests">
            <i class="fas fa-clipboard-list"></i>
            <h3>No Requests Found</h3>
            <p>No donation requests match your search criteria. Try adjusting your filters.</p>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
    function searchRequests() {
        const searchTerm = document.getElementById('requestSearch').value;
        const status = document.getElementById('requestStatusFilter').value;
        const priority = document.getElementById('requestPriorityFilter').value;
        
        // Build URL with parameters
        let url = window.location.pathname + '?';
        if (searchTerm) url += 'search=' + encodeURIComponent(searchTerm) + '&';
        if (status) url += 'status=' + status + '&';
        if (priority) url += 'priority=' + priority + '&';
        
        // Remove trailing & and navigate
        url = url.replace(/&$/, '');
        window.location.href = url;
    }

    function confirmApproval(requestId) {
        if (confirm('Are you sure you want to approve this donation request? This will notify the donor and schedule their appointment.')) {
            // Create a form and submit it
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/admin-panel/requests/${requestId}/approve/`;
            
            const csrfToken = document.createElement('input');
            csrfToken.type = 'hidden';
            csrfToken.name = 'csrfmiddlewaretoken';
            csrfToken.value = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            form.appendChild(csrfToken);
            document.body.appendChild(form);
            form.submit();
        }
    }

    function confirmReject(requestId) {
        if (confirm('Are you sure you want to reject this donation request? This will notify the donor of the rejection.')) {
            // Create a form and submit it
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/admin-panel/requests/${requestId}/reject/`;
            
            const csrfToken = document.createElement('input');
            csrfToken.type = 'hidden';
            csrfToken.name = 'csrfmiddlewaretoken';
            csrfToken.value = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            form.appendChild(csrfToken);
            document.body.appendChild(form);
            form.submit();
        }
    }

    function approveRequest(requestId) {
        confirmApproval(requestId);
    }

    function rejectRequest(requestId) {
        confirmReject(requestId);
    }

    function confirmComplete(requestId) {
        if (confirm('Are you sure you want to mark this donation as completed? This will:\n\n• Update the request status to Completed\n• Add the donation to history\n• Update the donor\'s last donation date\n• Notify the donor\n\nThis action cannot be undone.')) {
            // Create a form and submit it
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/admin-panel/requests/${requestId}/complete/`;
            
            const csrfToken = document.createElement('input');
            csrfToken.type = 'hidden';
            csrfToken.name = 'csrfmiddlewaretoken';
            csrfToken.value = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            form.appendChild(csrfToken);
            document.body.appendChild(form);
            form.submit();
        }
    }

    function confirmCancel(requestId) {
        const reason = prompt('Please enter the reason for cancelling this appointment:');
        if (reason !== null && reason.trim() !== '') {
            // Create a form and submit it
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/admin-panel/requests/${requestId}/cancel/`;
            
            const csrfToken = document.createElement('input');
            csrfToken.type = 'hidden';
            csrfToken.name = 'csrfmiddlewaretoken';
            csrfToken.value = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            const reasonInput = document.createElement('input');
            reasonInput.type = 'hidden';
            reasonInput.name = 'reason';
            reasonInput.value = reason;
            
            form.appendChild(csrfToken);
            form.appendChild(reasonInput);
            document.body.appendChild(form);
            form.submit();
        } else if (reason !== null) {
            alert('Please provide a reason for cancellation.');
        }
    }

    // Add enter key support for search
    document.getElementById('requestSearch').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            searchRequests();
        }
    });
</script>
{% endblock %}