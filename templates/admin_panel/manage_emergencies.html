{% extends 'admin_panel/base_admin.html' %}

{% block title %}Manage Emergency Requests | Blood Donor Information Management System{% endblock %}

{% block extra_css %}
<style>
    .emergency-card {
        background: white;
        border: 2px solid var(--color-danger-600);
        border-radius: var(--radius-lg);
        padding: var(--space-6);
        margin-bottom: var(--space-4);
        transition: var(--transition-base);
        position: relative;
    }

    .emergency-card:hover {
        box-shadow: var(--shadow-lg);
        transform: translateY(-2px);
    }

    .emergency-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--color-danger-600), var(--color-warning-600));
    }

    .emergency-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: var(--space-4);
    }

    .emergency-info h3 {
        color: var(--color-danger-600);
        margin-bottom: var(--space-1);
        font-size: var(--text-xl);
        display: flex;
        align-items: center;
        gap: var(--space-2);
    }

    .emergency-info p {
        color: var(--color-gray-600);
        font-size: var(--text-sm);
    }

    .urgency-badge {
        padding: var(--space-1) var(--space-3);
        border-radius: var(--radius-xl);
        font-size: var(--text-xs);
        font-weight: var(--font-weight-semibold);
        text-transform: uppercase;
    }

    .urgency-critical {
        background: var(--color-danger-50);
        color: var(--color-danger-600);
    }

    .urgency-high {
        background: var(--color-warning-50);
        color: var(--color-warning-600);
    }

    .urgency-medium {
        background: var(--color-info-50);
        color: var(--color-info-600);
    }

    .emergency-details {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: var(--space-4);
        margin-bottom: var(--space-4);
    }

    .detail-item {
        display: flex;
        flex-direction: column;
        gap: var(--space-1);
    }

    .detail-label {
        font-size: var(--text-xs);
        color: var(--color-gray-500);
        text-transform: uppercase;
        font-weight: var(--font-weight-semibold);
    }

    .detail-value {
        color: var(--color-gray-800);
        font-weight: var(--font-weight-medium);
    }

    .emergency-actions {
        display: flex;
        gap: var(--space-2);
        flex-wrap: wrap;
    }

    .btn-respond {
        background: var(--color-success-600);
        color: white;
    }

    .btn-respond:hover {
        background: #2e7d32;
    }

    .btn-contact {
        background: var(--color-info-600);
        color: white;
    }

    .btn-contact:hover {
        background: #1d4ed8;
    }

    .btn-resolve {
        background: var(--color-warning-600);
        color: white;
    }

    .btn-resolve:hover {
        background: #d97706;
    }

    .no-emergencies {
        text-align: center;
        padding: var(--space-12);
        color: var(--color-gray-500);
    }

    .no-emergencies i {
        font-size: var(--text-5xl);
        color: var(--color-success-600);
        margin-bottom: var(--space-4);
        opacity: 0.5;
    }

    .no-emergencies h3 {
        font-size: var(--text-2xl);
        margin-bottom: var(--space-2);
        color: var(--color-gray-700);
    }

    .stats-summary {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: var(--space-4);
        margin-bottom: var(--space-8);
    }

    .stat-item {
        background: var(--color-gray-50);
        padding: var(--space-4);
        border-radius: var(--radius-lg);
        text-align: center;
        border-left: 4px solid var(--color-primary-600);
    }

    .stat-item.critical {
        border-left-color: var(--color-danger-600);
    }

    .stat-item.high {
        border-left-color: var(--color-warning-600);
    }

    .stat-item.medium {
        border-left-color: var(--color-info-600);
    }

    .stat-number {
        font-size: var(--text-2xl);
        font-weight: var(--font-weight-bold);
        color: var(--color-primary-600);
        margin-bottom: var(--space-1);
    }

    .stat-item.critical .stat-number {
        color: var(--color-danger-600);
    }

    .stat-item.high .stat-number {
        color: var(--color-warning-600);
    }

    .stat-item.medium .stat-number {
        color: var(--color-info-600);
    }

    .stat-label {
        color: var(--color-gray-600);
        font-size: var(--text-sm);
        font-weight: var(--font-weight-medium);
    }

    .time-remaining {
        background: var(--color-danger-50);
        color: var(--color-danger-600);
        padding: var(--space-2);
        border-radius: var(--radius-md);
        font-size: var(--text-sm);
        font-weight: var(--font-weight-semibold);
        text-align: center;
        margin-bottom: var(--space-4);
    }

    .time-remaining.urgent {
        background: var(--color-danger-600);
        color: white;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.7; }
        100% { opacity: 1; }
    }
</style>
{% endblock %}

{% block content %}
{% csrf_token %}
<div class="page-header">
    <div>
        <h1 class="page-title">
            <i class="fas fa-exclamation-triangle"></i>
            Emergency Blood Requests
        </h1>
        <p class="page-subtitle">Handle urgent blood requests and emergency situations</p>
    </div>
    <a href="{% url 'admin_panel:create_emergency_request' %}" class="btn-action" style="background: var(--color-danger-600); color: white; padding: 0.75rem 1.5rem; border-radius: 8px; text-decoration: none; display: inline-flex; align-items: center; gap: 0.5rem; font-weight: 600; transition: all 0.3s;">
        <i class="fas fa-plus-circle"></i>
        Create Emergency Request
    </a>
</div>

<style>
.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
}

.btn-action:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
}

.tabs-container {
    background: white;
    border-radius: var(--radius-lg);
    padding: var(--space-4);
    margin-bottom: var(--space-6);
    box-shadow: var(--shadow-sm);
}

.tabs {
    display: flex;
    gap: var(--space-2);
    border-bottom: 2px solid var(--color-gray-200);
    margin-bottom: var(--space-4);
}

.tab-btn {
    padding: var(--space-3) var(--space-6);
    border: none;
    background: none;
    color: var(--color-gray-600);
    font-weight: var(--font-weight-semibold);
    cursor: pointer;
    transition: all 0.3s;
    border-bottom: 3px solid transparent;
    position: relative;
    bottom: -2px;
}

.tab-btn:hover {
    color: var(--color-primary-600);
}

.tab-btn.active {
    color: var(--color-danger-600);
    border-bottom-color: var(--color-danger-600);
}

.tab-badge {
    display: inline-block;
    margin-left: var(--space-2);
    padding: 0.125rem 0.5rem;
    background: var(--color-gray-200);
    border-radius: var(--radius-xl);
    font-size: var(--text-xs);
}

.tab-btn.active .tab-badge {
    background: var(--color-danger-600);
    color: white;
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}

@media (max-width: 768px) {
    .page-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
    }
    
    .tabs {
        flex-wrap: wrap;
    }
    
    .tab-btn {
        padding: var(--space-2) var(--space-4);
        font-size: var(--text-sm);
    }
}
</style>

<div class="content-container">
    <!-- Tabs Navigation -->
    <div class="tabs-container">
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('active')">
                <i class="fas fa-exclamation-circle"></i> Active Emergencies
                <span class="tab-badge">{{ active_emergencies|default:"0" }}</span>
            </button>
            <button class="tab-btn" onclick="switchTab('resolved')">
                <i class="fas fa-check-circle"></i> Resolved
                <span class="tab-badge">{{ fulfilled_emergencies|default:"0" }}</span>
            </button>
            <button class="tab-btn" onclick="switchTab('expired')">
                <i class="fas fa-clock"></i> Expired
                <span class="tab-badge">{{ expired_emergencies|default:"0" }}</span>
            </button>
        </div>
    </div>

    <!-- Active Emergencies Tab -->
    <div id="active-tab" class="tab-content active">
        <!-- Statistics Summary -->
        <div class="stats-summary">
            <div class="stat-item critical">
                <div class="stat-number">{{ critical_emergencies|default:"0" }}</div>
                <div class="stat-label">Critical</div>
            </div>
            <div class="stat-item high">
                <div class="stat-number">{{ high_emergencies|default:"0" }}</div>
                <div class="stat-label">High Priority</div>
            </div>
            <div class="stat-item medium">
                <div class="stat-number">{{ medium_emergencies|default:"0" }}</div>
                <div class="stat-label">Medium Priority</div>
            </div>
            <div class="stat-item">
                <div class="stat-number">{{ active_emergencies|default:"0" }}</div>
                <div class="stat-label">Active</div>
            </div>
        </div>

        <!-- Search and Filters -->
        <div class="search-bar">
            <input type="text" class="search-input" placeholder="Search by hospital or blood group..." id="emergencySearch">
            <select class="search-input" id="urgencyFilter">
                <option value="">All Urgency Levels</option>
                <option value="critical">Critical</option>
                <option value="high">High</option>
                <option value="medium">Medium</option>
            </select>
            <select class="search-input" id="bloodGroupFilter">
                <option value="">All Blood Groups</option>
                <option value="A+">A+</option>
                <option value="A-">A-</option>
                <option value="B+">B+</option>
                <option value="B-">B-</option>
                <option value="AB+">AB+</option>
                <option value="AB-">AB-</option>
                <option value="O+">O+</option>
                <option value="O-">O-</option>
            </select>
            <button class="search-btn" onclick="searchEmergencies()">
                <i class="fas fa-search"></i> Search
            </button>
        </div>

        <!-- Active Emergency Requests List -->
        {% if emergencies %}
            {% for request in emergencies %}
                {% if request.status == 'active' %}
                <div class="emergency-card">
                    {% if request.required_by %}
                    <div class="time-remaining {% if request.is_urgent %}urgent{% endif %}">
                        <i class="fas fa-clock"></i>
                        Required by: {{ request.required_by|date:"M d, Y H:i" }}
                        {% if request.is_urgent %}
                            - URGENT!
                        {% endif %}
                    </div>
                    {% endif %}

                    <div class="emergency-header">
                        <div class="emergency-info">
                            <h3>
                                <i class="fas fa-hospital"></i>
                                {{ request.hospital_name }}
                                {% if request.hospital.city %}
                                    <span style="font-size: 0.85em; color: #666; font-weight: 400;"> • {{ request.hospital.city }}</span>
                                {% endif %}
                            </h3>
                            <p>{{ request.contact_person }} • {{ request.contact_phone }} • ID: {{ request.id }}</p>
                        </div>
                        <div class="urgency-badge urgency-{{ request.urgency_level|default:'medium' }}">
                            {{ request.get_urgency_level_display|default:"Medium" }} Priority
                        </div>
                    </div>
                    
                    <div class="emergency-details">
                        <div class="detail-item">
                            <span class="detail-label">Blood Group Needed</span>
                            <span class="detail-value" style="color: var(--color-danger-600); font-weight: 700;">{{ request.blood_group_needed }}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Units Needed:</span>
                            <span class="detail-value" style="color: var(--color-danger-600); font-weight: 700;">{{ request.units_needed }}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Location</span>
                            <span class="detail-value">{{ request.location }}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Contact Person</span>
                            <span class="detail-value">{{ request.contact_person }}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Phone</span>
                            <span class="detail-value">{{ request.contact_phone }}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Status</span>
                            <span class="detail-value">{{ request.get_status_display }}</span>
                        </div>
                    </div>
                    
                    {% if request.notes %}
                    <div class="detail-item" style="margin-bottom: 1rem;">
                        <span class="detail-label">Notes</span>
                        <span class="detail-value">{{ request.notes }}</span>
                    </div>
                    {% endif %}
                    
                    <!-- Donor Responses Section -->
                    {% if request.responses.all %}
                    <div style="background: var(--color-info-50); border: 2px solid var(--color-info-600); padding: var(--space-4); border-radius: var(--radius-lg); margin-bottom: var(--space-4);">
                        <div style="display: flex; align-items: center; gap: var(--space-2); margin-bottom: var(--space-3);">
                            <i class="fas fa-users" style="color: var(--color-info-600);"></i>
                            <strong style="color: var(--color-info-700);">{{ request.responses.count }} Donor{{ request.responses.count|pluralize }} Responded</strong>
                        </div>
                        {% for response in request.responses.all %}
                        <div style="background: white; padding: var(--space-3); border-radius: var(--radius-md); margin-bottom: var(--space-2); border-left: 3px solid var(--color-success-600); display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong style="color: var(--color-gray-800);">{{ response.donor.full_name }}</strong>
                                <span style="margin: 0 var(--space-2); color: var(--color-gray-400);">|</span>
                                <span style="color: var(--color-danger-600); font-weight: 600;">{{ response.donor.blood_group }}</span>
                                <span style="margin: 0 var(--space-2); color: var(--color-gray-400);">|</span>
                                <a href="tel:{{ response.donor.phone_number }}" style="color: var(--color-info-600);">
                                    <i class="fas fa-phone"></i> {{ response.donor.phone_number }}
                                </a>
                                <span style="margin: 0 var(--space-2); color: var(--color-gray-400);">|</span>
                                <span style="color: var(--color-gray-500); font-size: var(--text-sm);">{{ response.created_at|date:"M d, H:i" }}</span>
                            </div>
                            <a href="{% url 'admin_panel:donor_detail' response.donor.id %}" class="btn btn-small" style="background: var(--color-primary-600); color: white;">
                                <i class="fas fa-user"></i> View Details
                            </a>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                    
                    <div class="emergency-actions">
                        <a href="tel:{{ request.contact_phone }}" class="btn btn-small btn-contact">
                            <i class="fas fa-phone"></i> Call Hospital
                        </a>
                        {% if request.is_own_hospital %}
                        <a href="{% url 'admin_panel:resolve_emergency' request.id %}" class="btn btn-small btn-resolve">
                            <i class="fas fa-check-circle"></i> Mark Resolved
                        </a>
                        {% else %}
                        <span class="btn btn-small" style="opacity: 0.6; cursor: default; background: var(--color-gray-400);" title="Only {{ request.hospital_name }} can resolve this">
                            <i class="fas fa-info-circle"></i> Call to Help
                        </span>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            {% endfor %}
        {% else %}
            <div class="no-emergencies">
                <i class="fas fa-check-circle"></i>
                <h3>No Active Emergencies</h3>
                <p>All emergency requests have been resolved. Great job!</p>
            </div>
        {% endif %}
    </div>

    <!-- Resolved Emergencies Tab -->
    <div id="resolved-tab" class="tab-content">
        <h2 style="color: var(--color-success-600); margin-bottom: var(--space-6); display: flex; align-items: center; gap: var(--space-2);">
            <i class="fas fa-check-double"></i>
            Resolved Emergency Requests
        </h2>
        
        {% if emergencies %}
            {% for request in emergencies %}
                {% if request.status == 'fulfilled' %}
                <div class="emergency-card" style="border-color: var(--color-success-600); opacity: 0.9;">
                    <div class="emergency-header">
                        <div class="emergency-info">
                            <h3 style="color: var(--color-success-600);">
                                <i class="fas fa-hospital"></i>
                                {{ request.hospital_name }}
                            </h3>
                            <p>{{ request.contact_person }} • {{ request.contact_phone }} • ID: {{ request.id }}</p>
                        </div>
                        <div class="urgency-badge" style="background: var(--color-success-50); color: var(--color-success-600);">
                            <i class="fas fa-check"></i> Resolved
                        </div>
                    </div>
                    
                    <div class="emergency-details">
                        <div class="detail-item">
                            <span class="detail-label">Blood Group</span>
                            <span class="detail-value">{{ request.blood_group_needed }}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Units Needed</span>
                            <span class="detail-value">{{ request.units_needed }}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Location</span>
                            <span class="detail-value">{{ request.location }}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Required By</span>
                            <span class="detail-value">{{ request.required_by|date:"M d, Y H:i" }}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Resolved On</span>
                            <span class="detail-value">{{ request.updated_at|date:"M d, Y H:i" }}</span>
                        </div>
                    </div>
                    
                    {% if request.notes %}
                    <div class="detail-item" style="margin-top: 1rem;">
                        <span class="detail-label">Resolution Notes</span>
                        <span class="detail-value" style="white-space: pre-line;">{{ request.notes }}</span>
                    </div>
                    {% endif %}
                </div>
                {% endif %}
            {% endfor %}
        {% else %}
            <div class="no-emergencies">
                <i class="fas fa-info-circle"></i>
                <h3>No Resolved Emergencies</h3>
                <p>Resolved emergency requests will appear here.</p>
            </div>
        {% endif %}
    </div>

    <!-- Expired Emergencies Tab -->
    <div id="expired-tab" class="tab-content">
        <h2 style="color: var(--color-gray-600); margin-bottom: var(--space-6); display: flex; align-items: center; gap: var(--space-2);">
            <i class="fas fa-history"></i>
            Expired Emergency Requests
        </h2>
        
        {% if emergencies %}
            {% for request in emergencies %}
                {% if request.status == 'expired' %}
                <div class="emergency-card" style="border-color: var(--color-gray-400); opacity: 0.8;">
                    <div class="emergency-header">
                        <div class="emergency-info">
                            <h3 style="color: var(--color-gray-600);">
                                <i class="fas fa-hospital"></i>
                                {{ request.hospital_name }}
                            </h3>
                            <p>{{ request.contact_person }} • {{ request.contact_phone }} • ID: {{ request.id }}</p>
                        </div>
                        <div class="urgency-badge" style="background: var(--color-gray-100); color: var(--color-gray-600);">
                            <i class="fas fa-clock"></i> Expired
                        </div>
                    </div>
                    
                    <div class="emergency-details">
                        <div class="detail-item">
                            <span class="detail-label">Blood Group</span>
                            <span class="detail-value">{{ request.blood_group_needed }}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Units Needed</span>
                            <span class="detail-value">{{ request.units_needed }}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Location</span>
                            <span class="detail-value">{{ request.location }}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Required By</span>
                            <span class="detail-value">{{ request.required_by|date:"M d, Y H:i" }}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Expired On</span>
                            <span class="detail-value">{{ request.updated_at|date:"M d, Y H:i" }}</span>
                        </div>
                    </div>
                    
                    {% if request.notes %}
                    <div class="detail-item" style="margin-top: 1rem;">
                        <span class="detail-label">Notes</span>
                        <span class="detail-value">{{ request.notes }}</span>
                    </div>
                    {% endif %}
                </div>
                {% endif %}
            {% endfor %}
        {% else %}
            <div class="no-emergencies">
                <i class="fas fa-info-circle"></i>
                <h3>No Expired Emergencies</h3>
                <p>Expired emergency requests will appear here.</p>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function switchTab(tabName) {
        // Hide all tab contents
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });
        
        // Remove active class from all tab buttons
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // Show selected tab content
        document.getElementById(tabName + '-tab').classList.add('active');
        
        // Add active class to selected tab button
        event.target.closest('.tab-btn').classList.add('active');
    }

    function searchEmergencies() {
        const searchTerm = document.getElementById('emergencySearch').value;
        const urgency = document.getElementById('urgencyFilter').value;
        const bloodGroup = document.getElementById('bloodGroupFilter').value;
        
        // Build URL with parameters
        let url = window.location.pathname + '?';
        if (searchTerm) url += 'search=' + encodeURIComponent(searchTerm) + '&';
        if (urgency) url += 'urgency=' + urgency + '&';
        if (bloodGroup) url += 'blood_group=' + bloodGroup + '&';
        
        // Remove trailing & and navigate
        url = url.replace(/&$/, '');
        window.location.href = url;
    }

    // Add enter key support for search
    document.getElementById('emergencySearch').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            searchEmergencies();
        }
    });

    // Auto-refresh every 30 seconds for critical emergencies
    setInterval(function() {
        if (document.querySelector('.time-remaining.urgent')) {
            location.reload();
        }
    }, 30000);
</script>
{% endblock %}